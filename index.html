<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work In Progress.</title>

<link href="https://fonts.googleapis.com/css2?family=Sixtyfour&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        padding: 0;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        height: 100vh;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        user-select: none;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Sixtyfour', monospace;
        font-size: 48px;
        z-index: 5;
        opacity: 1;
        transition: opacity 0.8s ease;
    }

    .hidden {
        opacity: 0;
        pointer-events: none;
    }

    #mainContent {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        height: 100%;
        position: relative;
        pointer-events: none;
    }

    #mainImage {
        margin-top: 40px;
        position: relative;
        filter: drop-shadow(0 0 8px #00ff00) drop-shadow(0 0 16px #00ff00);
        z-index: 2;
        -webkit-user-drag: none;
    }

    #hazard {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        z-index: 1;
        pointer-events: none;
        transition: opacity 0.05s ease;
        -webkit-user-drag: none;
    }
</style>
</head>
<body>

<div id="initOverlay" class="overlay">Initializing...</div>
<div id="clickOverlay" class="overlay hidden">Click Anywhere</div>

<div id="mainContent">
    <img id="mainImage" src="zxlpvx.png" alt="ZXLPVX" draggable="false">
    <img id="hazard" src="hazard.png" alt="Hazard" draggable="false">
    <audio id="beatAudio" src="beat.mp3" loop></audio>
</div>

<script>
const initOverlay = document.getElementById('initOverlay');
const clickOverlay = document.getElementById('clickOverlay');
const mainContent = document.getElementById('mainContent');

mainContent.addEventListener('contextmenu', e => e.preventDefault());

const imagesToLoad = ['zxlpvx.png','hazard.png'];
const audioToLoad = ['beat.mp3'];
const fontsToLoad = ['Sixtyfour'];

function preloadImages(urls) {
    return Promise.all(urls.map(url => new Promise((res) => {
        const img = new Image();
        img.src = url;
        img.onload = res;
        img.onerror = res;
    })));
}

function preloadAudio(urls) {
    return Promise.all(urls.map(url => new Promise(res => {
        const a = new Audio();
        a.src = url;
        a.oncanplaythrough = res;
        a.onerror = res;
    })));
}

function preloadFonts(names) {
    return Promise.all(names.map(name => {
        const font = new FontFace(name, `url(https://fonts.googleapis.com/css2?family=${name.replace(/ /g,'+')}&display=swap)`);
        return font.load().then(f => document.fonts.add(f)).catch(() => {});
    }));
}

Promise.all([
    preloadImages(imagesToLoad),
    preloadAudio(audioToLoad),
    preloadFonts(fontsToLoad)
]).then(() => {
    initOverlay.classList.add('hidden');
    setTimeout(() => clickOverlay.classList.remove('hidden'), 800);
});

clickOverlay.addEventListener('click', () => {
    clickOverlay.classList.add('hidden');
    mainContent.style.display = 'flex';

    const audio = document.getElementById('beatAudio');
    audio.play();

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const audioSource = audioCtx.createMediaElementSource(audio);
    const analyser = audioCtx.createAnalyser();

    audioSource.connect(analyser);
    analyser.connect(audioCtx.destination);

    analyser.fftSize = 256;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    const hazard = document.getElementById('hazard');

    const minBin = 0; 
    const maxBin = 10; 
    const bassThreshold = 221;
    let hazardVisible = false;

    function detectBassHit() {
        analyser.getByteFrequencyData(dataArray);

        let maxBass = 0;
        for(let i = minBin; i <= maxBin; i++){
            if(dataArray[i] > maxBass) maxBass = dataArray[i];
        }

        if(maxBass > bassThreshold){
            if(!hazardVisible){
                hazardVisible = true;
                hazard.style.opacity = 0.1;
            }
        } else {
            if(hazardVisible){
                hazardVisible = false;
                hazard.style.opacity = 0;
            }
        }

        requestAnimationFrame(detectBassHit);
    }

    audioCtx.resume().then(()=>detectBassHit());
});

document.addEventListener('dragstart', e => e.preventDefault());
</script>

</body>
</html>
